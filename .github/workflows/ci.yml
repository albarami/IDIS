name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  ui-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: ui/package-lock.json

      - name: Install dependencies
        working-directory: ui
        run: npm ci

      - name: Run lint
        working-directory: ui
        run: npm run lint

      - name: Run typecheck
        working-directory: ui
        run: npm run typecheck

      - name: Run tests
        working-directory: ui
        run: npm run test

      - name: Build
        working-directory: ui
        run: npm run build

  check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run all checks
        run: make check

  postgres-integration:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432/tcp

    env:
      PG_ADMIN_USER: postgres
      PG_ADMIN_PASSWORD: postgres
      IDIS_PG_APP_USER: idis_app
      IDIS_PG_APP_PASSWORD: idis_app_pw
      IDIS_PG_DB_NAME: idis_test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Mask secrets
        run: |
          echo "::add-mask::${PG_ADMIN_PASSWORD}"
          echo "::add-mask::${IDIS_PG_APP_PASSWORD}"

      - name: Set Postgres host and port
        run: |
          echo "IDIS_PG_HOST=127.0.0.1" >> "$GITHUB_ENV"
          echo "IDIS_PG_PORT=${{ job.services.postgres.ports['5432'] }}" >> "$GITHUB_ENV"

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Bootstrap PostgreSQL and export env
        run: |
          python scripts/pg_bootstrap_ci.py --export-github-env 2>&1 | tee postgres_bootstrap.log
          exit ${PIPESTATUS[0]}

      - name: Verify app role connectivity and security
        run: python scripts/pg_bootstrap_ci.py --verify-only

      - name: Run PostgreSQL integration tests
        env:
          IDIS_REQUIRE_POSTGRES: "1"
        run: |
          echo "=== Postgres Integration Tests (IDIS_REQUIRE_POSTGRES=1) ==="
          echo "Test files: test_postgres_rls_and_audit_immutability.py, test_api_deals_postgres.py, test_api_claims_postgres.py, test_postgres_break_attempts.py"
          pytest tests/test_postgres_rls_and_audit_immutability.py tests/test_api_deals_postgres.py tests/test_api_claims_postgres.py tests/test_postgres_break_attempts.py -v --junitxml=postgres_integration_pytest.xml 2>&1 | tee postgres_integration_pytest.log
          exit ${PIPESTATUS[0]}

      - name: Upload bootstrap log artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: postgres-bootstrap-log
          path: postgres_bootstrap.log
          retention-days: 7

      - name: Upload pytest log artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: postgres-integration-pytest-log
          path: postgres_integration_pytest.log
          retention-days: 7

      - name: Upload pytest JUnit XML artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: postgres-integration-pytest-xml
          path: postgres_integration_pytest.xml
          retention-days: 7

      - name: Write explicit pytest summary to job summary
        if: always()
        run: |
          python3 << 'EOF'
          import xml.etree.ElementTree as ET
          import os

          summary_file = os.environ.get("GITHUB_STEP_SUMMARY", "/dev/stdout")

          try:
              tree = ET.parse("postgres_integration_pytest.xml")
              root = tree.getroot()
              testsuite = root.find("testsuite") if root.tag != "testsuite" else root
              if testsuite is None:
                  testsuite = root

              tests = int(testsuite.get("tests", 0))
              failures = int(testsuite.get("failures", 0))
              errors = int(testsuite.get("errors", 0))
              skipped = int(testsuite.get("skipped", 0))
              passed = tests - failures - errors - skipped

              with open(summary_file, "a") as f:
                  f.write("## Postgres Integration Pytest Results\n\n")
                  f.write(f"**Postgres integration pytest: {passed} passed, {skipped} skipped**\n\n")
                  if failures > 0 or errors > 0:
                      f.write(f"⚠️ Failures: {failures}, Errors: {errors}\n\n")
          except Exception as e:
              with open(summary_file, "a") as f:
                  f.write(f"## Postgres Integration Pytest Results\n\n")
                  f.write(f"⚠️ Could not parse JUnit XML: {e}\n\n")
          EOF

      - name: Write logs summary to job summary
        if: always()
        run: |
          echo "## PostgreSQL Bootstrap Log (last 30 lines)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -30 postgres_bootstrap.log >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "No bootstrap log found" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## PostgreSQL Integration Test Results (last 50 lines)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -50 postgres_integration_pytest.log >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "No pytest log found" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  evaluation-harness:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run GDBS-S evaluation harness (validate mode)
        run: |
          echo "=== Running GDBS-S Evaluation Harness (validate mode) ==="
          # Use gdbs_mini fixture as guaranteed minimum dataset
          python -m idis test gdbs-s --dataset tests/fixtures/gdbs_mini --out gdbs_s_report.json
          exit_code=$?
          echo "Exit code: $exit_code"
          if [ $exit_code -eq 0 ]; then
            echo "✅ GDBS-S validation PASSED"
          elif [ $exit_code -eq 1 ]; then
            echo "❌ GDBS-S validation FAILED"
            exit 1
          elif [ $exit_code -eq 2 ]; then
            echo "⏸️ GDBS-S validation BLOCKED"
            exit 2
          fi

      - name: Display GDBS-S report
        if: always()
        run: |
          echo "=== GDBS-S Report ===" 
          cat gdbs_s_report.json 2>/dev/null || echo "No report file found"

      - name: Upload GDBS-S report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gdbs-s-evaluation-report
          path: gdbs_s_report.json
          retention-days: 30

      - name: Write evaluation summary to job summary
        if: always()
        run: |
          echo "## GDBS-S Evaluation Harness Results" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          cat gdbs_s_report.json >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo '{"error": "No report generated"}' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
